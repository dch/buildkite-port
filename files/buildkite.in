#!/bin/sh

# $FreeBSD$
#
# PROVIDE: buildkite
# REQUIRE: LOGIN NETWORKING SERVERS
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf.local or /etc/rc.conf
# to enable this service:
#
# buildkite_enable  (bool):   Set to NO by default.
# Set it to YES to enable buildkite.
#
# buildkite_config  (string): Optional full path for buildkite config file
# buildkite_token   (args):   Optional buildkite token
# buildkite_account (user):   Set to nobody by default.
# buildkite_vars    (env):    Pass in environment variables, "" by default
# buildkite_options (string): Pass in additional flags to agent
# buildkite_flags   (string): Pass in additional flags to daemon(8)

. /etc/rc.subr

name=buildkite
rcvar=buildkite_enable

load_rc_config $name

: ${buildkite_enable=NO}
: ${buildkite_logfile:=/var/log/buildkite.log}
: ${buildkite_account:=nobody}
: ${buildkite_config:="/usr/local/etc/buildkite/buildkite-agent.cfg"}
: ${buildkite_flags=""}
: ${buildkite_options=""}
: ${buildkite_vars=""}

sig_stop="INT"

pidfile=/var/run/buildkite.pid
command=/usr/sbin/daemon
command_args="-t ${name} \
    -u ${buildkite_account} \
    -P ${pidfile} \
    -o ${buildkite_logfile} \
    /usr/bin/env ${buildkite_vars} \
      HOME=`pw usershow ${buildkite_account} | cut -d: -f9` \
      BUILDKITE_AGENT_TOKEN=${buildkite_token} \
    /usr/local/bin/buildkite-agent start \
      --config ${buildkite_config} \
      --no-color \
      ${buildkite_options}"

required_files="${buildkite_config}"

_run_rc_killcmd()
{
    local _cmd
    local _pid

    # Terminate buildkite-agent by sending SIGINT to the child process to
    # ensure it unregisters and disconnects, otherwise the agent will still
    # be listed under the Agents tab.
    _pid=$(pgrep -P ${rc_pid})
    if [ -n "$_pid" ]; then
        _cmd="kill -$1 $_pid"
        if [ -n "$_user" ]; then
            _cmd="su -m ${_user} -c 'sh -c \"${_cmd}\"'"
        fi
    fi
    echo "$_cmd"
}

run_rc_command "$1"
